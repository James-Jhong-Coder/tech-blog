---
import { getCollection, render } from "astro:content";
import dayjs from "dayjs";
import Layout from "@/layouts/Layout.astro";
import Prose from "@/components/Prose.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import PostTag from "@/components/PostTag.astro";
import IconPostDate from "@/assets/icons/icon_post_date.svg";
import IconReadingTime from "@/assets/icons/icon_reading_time.svg";
import { getReadingTime } from "@/utils/readingTime";

export async function getStaticPaths() {
  const posts = await getCollection("posts", ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.id },
  }));
}

const { slug } = Astro.params;
const post = (await getCollection("posts")).find((p) => p.id === slug);

if (!post) {
  throw new Error(`Post not found: ${slug}`);
}
const readingTime = getReadingTime(post.body);
const { Content, headings } = await render(post);
---

<Layout rightSidebar={true}>
  <div class="post-header">
    <div class="post-meta">
      <span>{dayjs(post.data.createDate).format("YYYY-MM-DD")}</span>
      <span class="meta-sep">Â·</span>
      <span>{readingTime}</span>
    </div>
    <h1 class="post-title">{post.data.title}</h1>
    {post.data.description && (
      <p class="post-description">{post.data.description}</p>
    )}
    <div class="post-tags">
      {post.data.tags.map((tag, i) => (
        <a href={`/tags/${tag}`}>
          <PostTag title={tag} class={i > 0 ? "ml-1.5" : ""} />
        </a>
      ))}
    </div>
  </div>

  {post.data.coverImage && (
    <img
      src={post.data.coverImage}
      alt={post.data.title}
      class="w-full rounded-lg mt-6"
    />
  )}

  <div class="mt-8">
    <Prose>
      <Content />
    </Prose>
  </div>

  <TableOfContents headings={headings} slot="toc" />
</Layout>

<style>
  @reference "../../styles/global.css";

  .post-header {
    @apply pb-6;
    border-bottom: 1px solid var(--color-border);
  }
  .post-meta {
    @apply flex items-center gap-2;
    @apply text-sm;
    color: var(--color-text-muted);
  }
  .meta-sep {
    color: var(--color-border-light);
  }
  .post-title {
    @apply text-3xl font-bold mt-3;
    color: var(--color-text-primary);
  }
  .post-description {
    @apply mt-2 text-base;
    color: var(--color-text-secondary);
  }
  .post-tags {
    @apply mt-4 flex items-center flex-wrap;
  }
</style>
