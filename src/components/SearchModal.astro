<div id="search-modal" class="search-modal">
  <div class="search-backdrop"></div>
  <div class="search-dialog">
    <div class="search-input-wrapper">
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        id="search-input"
        type="text"
        class="search-input"
        placeholder="搜尋文章..."
        autocomplete="off"
      />
      <kbd class="search-kbd">Esc</kbd>
    </div>
    <div id="search-results" class="search-results">
      <div class="search-empty">輸入關鍵字搜尋文章</div>
    </div>
  </div>
</div>

<style>
  @reference "../styles/global.css";

  .search-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 60;
    align-items: flex-start;
    justify-content: center;
    padding-top: 10vh;
  }

  .search-modal.is-open {
    display: flex;
  }

  .search-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
  }

  .search-dialog {
    position: relative;
    width: 100%;
    max-width: 560px;
    max-height: 70vh;
    margin: 0 1rem;
    background-color: var(--color-bg-primary);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .search-input-wrapper {
    @apply flex items-center;
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--color-border);
    gap: 0.75rem;
  }

  .search-icon {
    @apply shrink-0;
    color: var(--color-text-muted);
  }

  .search-input {
    @apply flex-1 text-base;
    background: none;
    border: none;
    outline: none;
    color: var(--color-text-primary);
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-kbd {
    @apply shrink-0 text-xs;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--color-border);
    color: var(--color-text-muted);
    background-color: var(--color-bg-secondary);
  }

  .search-results {
    overflow-y: auto;
    padding: 0.5rem;
  }

  .search-empty {
    @apply text-sm text-center;
    padding: 2rem 1rem;
    color: var(--color-text-muted);
  }
</style>

<style is:global>
  @reference "../styles/global.css";

  .search-result-item {
    display: block;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    color: var(--color-text-primary);
    transition: background-color 0.15s;
  }

  .search-result-item:hover {
    background-color: var(--color-bg-tertiary);
  }

  .search-result-title {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-text-primary);
  }

  .search-result-item:hover .search-result-title {
    color: var(--color-accent);
  }

  .search-result-desc {
    font-size: 0.8125rem;
    margin-top: 0.25rem;
    color: var(--color-text-secondary);
  }

  .search-result-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.375rem;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .search-result-tag {
    padding: 1px 6px;
    border-radius: 9999px;
    background-color: rgba(211, 54, 130, 0.1);
    color: var(--color-accent);
    font-size: 0.6875rem;
  }

  .search-no-results {
    text-align: center;
    padding: 2rem 1rem;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
</style>

<script>
  const modal = document.getElementById("search-modal");
  const input = document.getElementById("search-input") as HTMLInputElement;
  const resultsContainer = document.getElementById("search-results");
  const backdrop = modal?.querySelector(".search-backdrop");

  let posts: Array<{
    id: string;
    title: string;
    description: string;
    tags: string[];
    category: string;
    createDate: string;
  }> = [];
  let loaded = false;

  async function loadIndex() {
    if (loaded) return;
    try {
      const res = await fetch("/search-index.json");
      posts = await res.json();
      loaded = true;
    } catch {
      console.error("Failed to load search index");
    }
  }

  function openSearch() {
    loadIndex();
    modal?.classList.add("is-open");
    document.body.style.overflow = "hidden";
    setTimeout(() => input?.focus(), 50);
  }

  function closeSearch() {
    modal?.classList.remove("is-open");
    document.body.style.overflow = "";
    if (input) input.value = "";
    if (resultsContainer) {
      resultsContainer.innerHTML =
        '<div class="search-empty">輸入關鍵字搜尋文章</div>';
    }
  }

  function search(query: string) {
    if (!resultsContainer) return;

    if (!query.trim()) {
      resultsContainer.innerHTML =
        '<div class="search-empty">輸入關鍵字搜尋文章</div>';
      return;
    }

    const q = query.toLowerCase();
    const results = posts.filter(
      (post) =>
        post.title.toLowerCase().includes(q) ||
        post.description.toLowerCase().includes(q) ||
        post.tags.some((tag) => tag.toLowerCase().includes(q)),
    );

    if (results.length === 0) {
      resultsContainer.innerHTML =
        '<div class="search-no-results">找不到相關文章</div>';
      return;
    }

    resultsContainer.innerHTML = results
      .map(
        (post) => `
        <a href="/posts/${post.id}" class="search-result-item">
          <div class="search-result-title">${escapeHtml(post.title)}</div>
          ${post.description ? `<div class="search-result-desc">${escapeHtml(post.description)}</div>` : ""}
          <div class="search-result-meta">
            <span>${post.createDate}</span>
            ${post.tags.map((tag) => `<span class="search-result-tag">${escapeHtml(tag)}</span>`).join("")}
          </div>
        </a>
      `,
      )
      .join("");
  }

  function escapeHtml(str: string) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  // Event listeners
  input?.addEventListener("input", () => search(input.value));

  backdrop?.addEventListener("click", closeSearch);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modal?.classList.contains("is-open")) {
      closeSearch();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === "k") {
      e.preventDefault();
      if (modal?.classList.contains("is-open")) {
        closeSearch();
      } else {
        openSearch();
      }
    }
  });

  // Listen for custom event from search buttons
  document.addEventListener("open-search", openSearch);
</script>
